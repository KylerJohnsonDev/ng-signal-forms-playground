<div class="container">
  <h2>Patient Intake Form - Reactive</h2>

  <div class="stepper">
    <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">1. Personal Info</div>
    <div class="line"></div>
    <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">2. Details</div>
    <div class="line"></div>
    <div class="step" [class.active]="currentStep === 3">3. Preferences</div>
  </div>

  <form [formGroup]="intakeForm" (ngSubmit)="onSubmit()">

    <!-- Step 1: Personal Info -->
    @if (currentStep === 1) {
    <div class="form-step">
      <div class="form-group">
        <label for="fullName">Full Name</label>
        <input id="fullName" type="text" formControlName="fullName" placeholder="Enter full name">
        @if (intakeForm.get('fullName')?.invalid && intakeForm.get('fullName')?.touched) {
        <div class="error">
          @if (intakeForm.get('fullName')?.errors?.['required']) {
          <span>Full Name is required.</span>
          }
          @if (intakeForm.get('fullName')?.errors?.['minlength']) {
          <span>Full Name must be at least 3
            characters.</span>
          }
        </div>
        }
      </div>
      <div class="form-group">
        <label for="dateOfBirth">Date of Birth</label>
        <input id="dateOfBirth" type="date" formControlName="dateOfBirth">
        @if (intakeForm.get('dateOfBirth')?.invalid && intakeForm.get('dateOfBirth')?.touched) {
        <div class="error">
          Date of Birth is required.
        </div>
        }
        <div class="age-display">
          <strong>Age:</strong> {{ calculatedAge() }}
        </div>
      </div>
      <div class="form-group">
        <label>Gender</label>
        <div ngCombobox #combobox="ngCombobox" readonly>
          <div #origin class="select"
            [class.invalid]="intakeForm.get('gender')?.invalid && intakeForm.get('gender')?.touched">
            <span class="combobox-label">
              <span class="selected-label-text">{{ genderDisplayValue }}</span>
            </span>
            <input aria-label="Gender" ngComboboxInput />
            <span class="arrow">▼</span>
          </div>
          <ng-template ngComboboxPopupContainer>
            <ng-template [cdkConnectedOverlay]="{origin, usePopover: 'inline', matchWidth: true}"
              [cdkConnectedOverlayOpen]="true">
              <div class="popup-container">
                <div ngListbox>
                  @for (option of genderOptions; track option.value) {
                  <div ngOption [value]="option.value" [label]="option.label" (click)="setGender(option.value)">
                    <span class="option-text">{{option.label}}</span>
                    <span class="check">✓</span>
                  </div>
                  }
                </div>
              </div>
            </ng-template>
          </ng-template>
        </div>
      </div>
      <div class="form-group">
        <label for="phoneNumber">Phone Number</label>
        <input id="phoneNumber" type="tel" formControlName="phoneNumber" placeholder="(555) 555-5555" />
        @if (intakeForm.get('phoneNumber')?.invalid && intakeForm.get('phoneNumber')?.touched) {
        <div class="error">
          @if (intakeForm.get('phoneNumber')?.errors?.['required']) {
          <span>Phone Number is required.</span>
          }
          @if (intakeForm.get('phoneNumber')?.errors?.['pattern']) {
          <span>Invalid phone number format
            (xxx-xxx-xxxx).</span>
          }
        </div>
        }
      </div>
    </div>
    }

    <!-- Step 2: Medical Info -->
    @if (currentStep === 2) {
    <div class="form-step">
      <div class="form-group">
        <label for="primaryComplaint">Primary Complaint</label>
        <textarea id="primaryComplaint" formControlName="primaryComplaint"
          placeholder="Describe your primary complaint"></textarea>
        @if (intakeForm.get('primaryComplaint')?.invalid && intakeForm.get('primaryComplaint')?.touched) {
        <div class="error">
          Primary Complaint is required.
        </div>
        }
      </div>
      <div class="form-group">
        <label for="allergies">Allergies</label>
        <textarea id="allergies" formControlName="allergies" placeholder="List any allergies"></textarea>
      </div>
      <div class="form-group">
        <label for="medications">Current Medications</label>
        <textarea id="medications" formControlName="medications" placeholder="List current medications"></textarea>
      </div>
    </div>
    }

    <!-- Step 3: Insurance & Consent -->
    @if (currentStep === 3) {
    <div class="form-step">
      <div class="form-group">
        <label for="insuranceProvider">Insurance Provider</label>
        <input id="insuranceProvider" type="text" formControlName="insuranceProvider"
          placeholder="Enter insurance provider">
      </div>
      <div class="form-group">
        <label for="policyNumber">Policy Number</label>
        <input id="policyNumber" type="text" formControlName="policyNumber" placeholder="Enter policy number">
      </div>
      <div class="form-group checkbox-group">
        <label>
          <input type="checkbox" formControlName="consentToTreat"> I consent to treatment
        </label>
        @if (intakeForm.get('consentToTreat')?.invalid && intakeForm.get('consentToTreat')?.touched) {
        <div class="error">
          Consent is required.
        </div>
        }
      </div>
    </div>
    }

    <!-- Navigation Buttons -->
    <div class="actions">
      <button type="button" (click)="prevStep()" [disabled]="currentStep === 1" class="btn-secondary">Previous</button>
      @if (currentStep < 3) { <button type="button" (click)="nextStep()" class="btn-primary" [disabled]="!validateCurrentStep()">Next</button>
        }
        @if (currentStep === 3) {
        <button type="submit" class="btn-success">Submit</button>
        }
    </div>

  </form>
</div>
