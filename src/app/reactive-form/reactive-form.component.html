<div class="container">
  <h2>Patient Intake Form - Reactive</h2>

  <div class="stepper">
    <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">1. Patient Info</div>
    <div class="line"></div>
    <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">2. Medical History</div>
    <div class="line"></div>
    <div class="step" [class.active]="currentStep === 3">3. Insurance & Consent</div>
  </div>

  <form [formGroup]="intakeForm" (ngSubmit)="onSubmit()">

    <!-- Step 1: Patient Info -->
    @if (currentStep === 1) {
    <div class="form-step">
      <div class="form-group">
        <label for="fullName">Full Name *</label>
        <input id="fullName" type="text" formControlName="fullName" placeholder="Enter full name">
        @if (intakeForm.get('fullName')?.invalid && intakeForm.get('fullName')?.touched) {
        <app-validation-errors [errors]="getErrorsForField('fullName')" />
        }
      </div>
      <div class="form-group">
        <label for="dateOfBirth">Date of Birth *</label>
        <input id="dateOfBirth" type="date" formControlName="dateOfBirth">
        @if (intakeForm.get('dateOfBirth')?.invalid && intakeForm.get('dateOfBirth')?.touched) {
        <app-validation-errors [errors]="getErrorsForField('dateOfBirth')" />
        }
        <div class="age-display">
          <strong>Age:</strong> {{ calculatedAge() }}
        </div>
      </div>
      <div class="form-group">
        <label id="gender-label">Gender</label>
        <div ngCombobox #combobox="ngCombobox" readonly>
          <div #origin class="select"
            [class.invalid]="intakeForm.get('gender')?.invalid && intakeForm.get('gender')?.touched">
            <span class="combobox-label">
              <span class="selected-label-text">{{ genderDisplayValue }}</span>
            </span>
            <input aria-labelledby="gender-label" ngComboboxInput />
            <span class="arrow">▼</span>
          </div>
          <ng-template ngComboboxPopupContainer>
            <ng-template [cdkConnectedOverlay]="{origin, usePopover: 'inline', matchWidth: true}"
              [cdkConnectedOverlayOpen]="true">
              <div class="popup-container">
                <div ngListbox>
                  @for (option of genderOptions; track option.value) {
                  <div ngOption [value]="option.value" [label]="option.label" (click)="setGender(option.value)">
                    <span class="option-text">{{option.label}}</span>
                    <span class="check">✓</span>
                  </div>
                  }
                </div>
              </div>
            </ng-template>
          </ng-template>
        </div>
      </div>
      <div class="form-group">
        <label for="phoneNumber">Phone Number *</label>
        <input id="phoneNumber" type="tel" formControlName="phoneNumber" placeholder="555-555-5555" />
        @if (intakeForm.get('phoneNumber')?.invalid && intakeForm.get('phoneNumber')?.touched) {
        <app-validation-errors [errors]="getErrorsForField('phoneNumber')" />
        }
      </div>
    </div>
    }

    <!-- Step 2: Medical History -->
    @if (currentStep === 2) {
    <div class="form-step">
      <div class="form-group">
        <label for="primaryComplaint">Primary Complaint *</label>
        <textarea id="primaryComplaint" formControlName="primaryComplaint" rows="3"
          placeholder="Describe your main reason for visiting"></textarea>
        @if (intakeForm.get('primaryComplaint')?.invalid && intakeForm.get('primaryComplaint')?.touched) {
        <app-validation-errors [errors]="getErrorsForField('primaryComplaint')" />
        }
      </div>
      <div class="form-group">
        <label for="allergies">Allergies</label>
        <textarea id="allergies" formControlName="allergies" rows="2" placeholder="List any allergies"></textarea>
      </div>
      <div class="form-group">
        <label for="medications">Current Medications</label>
        <textarea id="medications" formControlName="medications" rows="2"
          placeholder="List current medications"></textarea>
      </div>
    </div>
    }

    <!-- Step 3: Insurance & Consent -->
    @if (currentStep === 3) {
    <div class="form-step">
      <div class="form-group">
        <label for="insuranceProvider">Insurance Provider</label>
        <input id="insuranceProvider" type="text" formControlName="insuranceProvider" placeholder="Provider Name">
      </div>
      <div class="form-group">
        <label for="policyNumber">Policy Number @if (insuranceProvider()) {<span
            class="required-indicator">*</span>}</label>
        <input id="policyNumber" type="text" formControlName="policyNumber" placeholder="Policy #">
        @if (intakeForm.get('policyNumber')?.invalid && intakeForm.get('policyNumber')?.touched) {
        <app-validation-errors [errors]="getErrorsForField('policyNumber')" />
        }
      </div>
      <div class="form-group checkbox-group">
        <label>
          <input type="checkbox" formControlName="consentToTreat"> I consent to treatment and agree to the clinic's
          policies. *
        </label>
        @if (intakeForm.get('consentToTreat')?.invalid && intakeForm.get('consentToTreat')?.touched) {
        <app-validation-errors [errors]="getErrorsForField('consentToTreat')" />
        }
      </div>
    </div>
    }

    <!-- Navigation Buttons -->
    <div class="actions">
      <button type="button" (click)="prevStep()" [disabled]="currentStep === 1" class="btn-secondary">Previous</button>
      @if (currentStep < 3) { <button type="button" (click)="nextStep()" class="btn-primary"
        [disabled]="!validateCurrentStep()">Next</button>
        }
        @if (currentStep === 3) {
        <button type="submit" class="btn-success" [disabled]="intakeForm.get('consentToTreat')?.invalid">Submit</button>
        }
    </div>

  </form>
</div>